#!/usr/bin/env python3
import sys
from utils.analyser.network_loader import load_combined_network
from utils.analyser.fen_parser import parse_fen
from utils.training.training_mode import train_mode
from utils.prediction.prediction_mode import predict_mode

def parse_arguments(args):
    """
    Parses the command-line arguments.
    Args:
        args (list): List of command-line arguments.
    Returns:
        tuple: (mode, curve_enabled, load_file, input_file, save_file, spec)
    """
    if len(args) < 3 or (args[1] not in ['--train', '--predict']):
        print("USAGE: ./my_torch_analyzer [--predict | --train [+curve] [--save SAVEFILE] [--spec N]] LOADFILE FILE", file=sys.stderr)
        sys.exit(84)

    mode = args[1]
    curve_enabled = False
    spec = None
    save_file = None

    # optional arguments
    if '+curve' in args:
        curve_enabled = True
    if '--spec' in args:
        try:
            spec_index = args.index('--spec') + 1
            spec = int(args[spec_index])
        except (IndexError, ValueError):
            print("Error: Invalid value for --spec. Must be an integer.", file=sys.stderr)
            sys.exit(84)
    if '--save' in args:
        try:
            save_index = args.index('--save') + 1
            save_file = args[save_index]
        except IndexError:
            print("Error: --save requires a file path.", file=sys.stderr)
            sys.exit(84)

    # load_file and input_file
    base_args = [arg for arg in args[2:] if arg not in ['+curve', '--spec', str(spec), '--save', save_file]]
    if len(base_args) < 2:
        print("Error: Missing LOADFILE or FILE arguments.", file=sys.stderr)
        sys.exit(84)

    load_file = base_args[0]
    input_file = base_args[1]
    save_file = save_file if save_file else load_file

    return mode, curve_enabled, load_file, input_file, save_file, spec

def load_chessboards(input_file):
    print(f"Loading chessboards from: {input_file}", file=sys.stderr)
    with open(input_file, 'r') as file:
        chessboards = file.readlines()
    data = []
    print(f"Processing {len(chessboards)} chessboards...", file=sys.stderr)
    for idx, line in enumerate(chessboards):
        try:
            parts = line.strip().split(' ')
            if len(parts) < 7:
                raise ValueError("Line does not contain enough fields.")
            fen_string = ' '.join(parts[:6])
            label = ' '.join(parts[6:])
            inputs = parse_fen(fen_string)
            data.append((inputs, label))
        except ValueError as e:
            print(f"Error parsing line {idx + 1}: {e}", file=sys.stderr)
    return data

def main(args):
    mode, curve_enabled, load_file, input_file, save_file, spec = parse_arguments(args)
    print(f"Loading networks from: {load_file}", file=sys.stderr)
    networks = load_combined_network(load_file)
    data = load_chessboards(input_file)

    if mode == '--train':
        train_mode(networks, data, curve_enabled, save_file, spec)
    elif mode == '--predict':
        predict_mode(networks, data)

if __name__ == "__main__":
    main(sys.argv)
